on:
  workflow_call:
    inputs:
      application:
        required: true
        type: string
      lambdas-with-dependant-modules:
        required: true
        type: string
    outputs:
      lambda-artifact-name:
        description: "Constructed name of the lambda artifact"
        value: ${{ jobs.build.outputs.lambda-artifact-name }}

jobs:
  build:
    name: Build application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      lambda-artifact-name: ${{ steps.construct-lambda-artifact-name.outputs.name }}
    steps:
      - name: "‚òÅÔ∏è checkout repository"
        uses: actions/checkout@v3

      - name: "üîß install python 3.9"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "üíæ fetch project dependencies"
        uses: actions/cache@v3
        with:
          key: ${{ inputs.application }}-dependencies-${{ github.run_number }}
          path: ./${{ inputs.application }}/source/venv
          fail-on-cache-miss: true

      - name: "üîç run build"
        run: |
          cd "${{ inputs.application }}"/source || exit

          echo "Creating a directory for artifact."
          mkdir target

          LAMBDAS_WITH_DEPENDANT_MODULES="${{ inputs.lambdas-with-dependant-modules }}"

          LAMBDAS_ARRAY=($(echo $LAMBDAS_WITH_DEPENDANT_MODULES | tr " " "\n"))

          for i in "${LAMBDAS_ARRAY[@]}"
          do
            # echo $i
            LAMBDA_ARRAY=($(echo $i | tr "=" "\n"))
            LAMBDA_NAME=${LAMBDA_ARRAY[0]}

            FILES_FOLDERS_TO_ADD=$(echo ${LAMBDA_ARRAY[1]} | tr ',' ' ')
            LAMBDA_ARTIFACT_NAME="$LAMBDA_NAME-${{ github.run_number }}.zip"

            echo "FILES_FOLDERS_TO_ADD=$FILES_FOLDERS_TO_ADD"
            echo "LAMBDA_ARTIFACT_NAME=$LAMBDA_ARTIFACT_NAME"

            echo "Creating a package with dependencies."
            (
              cd venv/lib/python3.9/site-packages/ || exit
              zip -q -r ../../../../target/"${LAMBDA_ARTIFACT_NAME}" .
            )

            echo "Adding source code to the package."
            zip -q -g -r target/"${LAMBDA_ARTIFACT_NAME}" $FILES_FOLDERS_TO_ADD

            echo "Created artifact."
            ls -l target/"${LAMBDA_ARTIFACT_NAME}"

          done

      - name: "üíæ save lambda artifacts"
        uses: actions/cache@v3
        with:
          key: ${{ steps.construct-lambda-artifact-name.outputs.name }}
          path: ./${{ inputs.application }}/source/target
